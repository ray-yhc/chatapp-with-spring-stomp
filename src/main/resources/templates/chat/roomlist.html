<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Chat</title>

    <!-- CSS -->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"-->
<!--          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">-->
    <link rel="stylesheet" type="text/css" href="/static/css/style.css" th:href="@{/css/style.css}"/>

</head>
<body>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>


<div id="chatbox">
    <div id="friendslist">
        <div id="topmenu">
            <span class="friends"></span>
            <span class="chats"></span>
            <span class="history"></span>
        </div>

        <div id="rooms">
            <div class="room">
                <img src="https://placeimg.com/128/128/people"/>
                <p>
                    <strong>Miro Badev</strong>
                    <span>최근 메시지</span>
                </p>
                <div class="status available"></div>
            </div>

        </div>

        <div id="search">
            <input type="text" class="create-room" id="searchfield" value="create new room"/>
        </div>
    </div>
</div>


<!-- JavaScript -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>

    class Lobby {
        constructor() {
            this.chatrooms = [];
            this.updateRoomList();
        }

        findAllRoom(callback) {
            axios.get('/app/chat/room')
                .then(response => {
                    this.chatrooms = response.data;
                    callback();
                });
        }

        updateRoomList() {
            this.findAllRoom(() => {
                if (!this.chatrooms) {
                    this.chatrooms = [];
                }
                if (this.chatrooms.length !== 0) {
                    let listHtml = '';
                    this.chatrooms.forEach(room => {
                        listHtml += `<div class="room" onclick="enterRoom('${room.roomId}')"> \
                            <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/5_copy.jpg"/> \
                            <p> \
                                <strong>${room.roomName}</strong> \
                                <span>최근 메시지</span> \
                            </p> \
                            <span class="date">12분 전</span> \
                        </div>`;

                    });
                    document.querySelector('#rooms').innerHTML = listHtml;
                }
            });
        }
    }

    // 초기 작업 : lobby객체 생성, 데이터 불러오기
    const lobby = new Lobby();

    // eventListener 생성
    let createRoomInput = document.querySelector('input.create-room');
    // let createRoomButton = document.querySelector('button.create-room');

    createRoomInput.addEventListener('keyup', function (e) {
        if (e.keyCode === 13) {
            var room_name = e.target.value;
            createRoom(room_name)
        }
    });
    // createRoomButton.addEventListener('click', function () {
    //     var room_name = createRoomInput.value;
    //     createRoom(room_name)
    // });

    // 새로운 방 생성
    function createRoom(room_name) {
        if ("" === room_name) {
            alert("방 제목을 입력해 주십시요.");
            return;
        } else {
            var params = new URLSearchParams();
            params.append("name", room_name); // query param 추가
            axios.post('/app/chat/room', params) // post request
                .then(
                    response => {
                        alert(response.data.roomName + "방 개설에 성공하였습니다.")
                        room_name = '';
                        // todo: redirect
                        lobby.updateRoomList();
                    }
                )
                .catch(error => {
                    console.log(error);
                    alert("채팅방 개설에 실패하였습니다.");
                });
        }
    }

    // 방 입장
    function enterRoom(roomId) {
        var sender = prompt('닉네임을 입력해 주세요.');
        if (sender !== "") {
            localStorage.setItem('wschat.sender', sender);
            localStorage.setItem('wschat.roomId', roomId);
            location.href = "/chat/room/" + roomId;
        } else {
            alert("닉네임을 입력해 주십시요.");
        }
    }

    // search 커서 입력시 동작
    $("#searchfield").focus(function(){
        if($(this).val() == "create new room"){
            $(this).val("");
        }
    });
    $("#searchfield").focusout(function(){
        if($(this).val() == ""){
            $(this).val("Search contacts...");

        }
    });
</script>
</body>
</html>